{{define "day"}}
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{if .TalkerLabel}}{{.TalkerLabel}}{{else}}{{.Talker}}{{end}} · {{.Date}} 群聊日报</title>
  <meta name="robots" content="noindex"/>
  <meta name="color-scheme" content="light dark"/>
  <link rel="prefetch" href="../index.html"/>
  <link rel="prefetch" href="../../index.html"/>
  <link rel="prefetch" href="/index.html"/>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f6f7fb;
      --fg: #161823;
      --muted: #5f6b7d;
      --card-bg: #ffffff;
      --border: #e0e4ef;
      --accent: #3563ff;
      --accent-soft: rgba(53, 99, 255, 0.15);
      --shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
    }
    [data-theme="dark"] {
      --bg: #070a14;
      --fg: #e6ebff;
      --muted: #94a0c2;
      --card-bg: #0f1527;
      --border: #20263a;
      --accent: #7aa2ff;
      --accent-soft: rgba(122, 162, 255, 0.15);
      --shadow: 0 12px 40px rgba(7, 12, 26, 0.6);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 32px 24px 72px;
      font-family: "SF Pro Display", "Segoe UI", "PingFang SC", "Microsoft YaHei", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.7;
      max-width: 1080px;
      margin-left: auto;
      margin-right: auto;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .page-header {
      display: flex;
      justify-content: space-between;
      gap: 32px;
      flex-wrap: wrap;
      margin-bottom: 28px;
    }
    .page-header .title {
      flex: 1 1 280px;
    }
    .eyebrow {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 13px;
      letter-spacing: 0.04em;
    }
    h1 {
      margin: 12px 0 4px;
      font-size: 28px;
      font-weight: 700;
    }
    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 15px;
    }
    .stat-chips {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      min-width: 260px;
    }
    .chip {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: var(--shadow);
    }
    .chip-label { display: block; font-size: 13px; color: var(--muted); }
    .chip-value { display: block; font-size: 26px; font-weight: 600; margin-top: 4px; }

    main { display: grid; gap: 24px; }

    .panel {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px 28px;
      box-shadow: var(--shadow);
    }
    .panel-highlight {
      background: linear-gradient(135deg, rgba(53,99,255,0.08), rgba(53,99,255,0.02));
    }
    .panel h2 {
      margin: 0 0 14px;
      font-size: 20px;
    }
    .panel h3 { margin: 12px 0 6px; font-size: 16px; }
    .panel p.lead { font-size: 16px; margin-bottom: 12px; }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .metric-card {
      padding: 18px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(6px);
    }
    [data-theme="dark"] .metric-card {
      background: rgba(15, 21, 39, 0.65);
    }
    .metric-card strong { display: block; font-size: 14px; color: var(--muted); }
    .metric-card .value { font-size: 30px; font-weight: 700; margin: 6px 0; }
    .metric-card span { font-size: 13px; color: var(--muted); }

    .insight-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }
    .insight-grid ul {
      margin: 8px 0 0;
      padding-left: 20px;
    }
    .insight-grid li { margin-bottom: 6px; }

    .activity-bars {
      display: grid;
      grid-template-columns: repeat(24, minmax(10px, 1fr));
      gap: 6px;
      align-items: end;
      height: 160px;
      margin-top: 16px;
    }
    .activity-bar {
      position: relative;
      background: rgba(53, 99, 255, 0.08);
      border-radius: 8px 8px 2px 2px;
      overflow: hidden;
    }
    .activity-bar::after {
      content: "";
      position: absolute;
      inset: auto 0 0 0;
      height: calc(var(--value, 0) * 1%);
      min-height: 2px;
      background: linear-gradient(180deg, rgba(53,99,255,0.85), rgba(53,99,255,0.4));
    }
    .activity-labels {
      display: grid;
      grid-template-columns: repeat(24, minmax(10px, 1fr));
      gap: 6px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }
    .rank-list { list-style: none; margin: 0; padding: 0; }
    .rank-item { margin-bottom: 14px; }
    .rank-item strong { font-size: 15px; }
    .rank-meter {
      height: 6px;
      background: var(--accent-soft);
      border-radius: 4px;
      margin-top: 6px;
      overflow: hidden;
    }
    .rank-meter span {
      display: block;
      height: 100%;
      background: var(--accent);
      width: var(--value, 0%);
    }

    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .chip-list span {
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(53, 99, 255, 0.12);
      color: var(--accent);
      font-size: 13px;
    }

    details.report-messages {
      margin-top: 12px;
    }
    details.report-messages summary {
      cursor: pointer;
      padding: 12px 16px;
      background: rgba(53, 99, 255, 0.08);
      border-radius: 12px;
      font-weight: 600;
    }
    .message-stream {
      margin-top: 16px;
      display: grid;
      gap: 16px;
    }
    .msg-card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 16px;
      background: var(--card-bg);
    }
    .msg-meta {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .msg-body { margin-top: 8px; font-size: 15px; white-space: pre-wrap; }
    .msg-body img { max-width: 100%; border-radius: 12px; }

    footer {
      margin-top: 32px;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 720px) {
      body { padding: 18px 16px 56px; }
      .page-header { flex-direction: column; }
      .stat-chips { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
      .activity-bars { height: 120px; }
    }
  </style>
  <script>
    document.documentElement.dataset.theme = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  </script>
</head>
<body>
  <header class="page-header">
    <div class="title">
      <span class="eyebrow">群聊日报</span>
      <h1>{{if .TalkerLabel}}{{.TalkerLabel}}{{else}}{{.Talker}}{{end}}</h1>
      <p class="subtitle">{{.Date}}{{if .Keyword}} · 关键词：{{.Keyword}}{{end}}</p>
    </div>
    <div class="stat-chips">
      <div class="chip"><span class="chip-label">消息总数</span><span class="chip-value">{{.Summary.TotalMessages}}</span></div>
      <div class="chip"><span class="chip-label">活跃成员</span><span class="chip-value">{{.Summary.UniqueSenders}}</span></div>
      <div class="chip"><span class="chip-label">图片消息</span><span class="chip-value">{{.Summary.ImageCount}}</span></div>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>今日数据概览</h2>
      <div class="metric-grid">
        <div class="metric-card">
          <strong>峰值活跃时段</strong>
          <div class="value">{{printf "%02d:00" .Summary.PeakHour}}</div>
          <span>该时段共 {{index .Summary.HourlyHistogram .Summary.PeakHour}} 条消息</span>
        </div>
        <div class="metric-card">
          <strong>Top 发送者</strong>
          {{if .Summary.TopSenders}}
            <div class="value">{{(index .Summary.TopSenders 0).Key}}</div>
            <span>发送 {{(index .Summary.TopSenders 0).Count}} 条</span>
          {{else}}
            <div class="value">暂无</div>
          {{end}}
        </div>
        <div class="metric-card">
          <strong>热门主题</strong>
          {{if .Summary.Topics}}
            <div class="value">{{(index .Summary.Topics 0).Name}}</div>
            <span>共 {{(index .Summary.Topics 0).Count}} 次提及</span>
          {{else}}
            <div class="value">暂无</div>
          {{end}}
        </div>
        <div class="metric-card">
          <strong>热门链接数量</strong>
          <div class="value">{{len .Summary.TopLinks}}</div>
          {{if .Summary.TopLinks}}
            <span>例如：{{host (index .Summary.TopLinks 0)}}</span>
          {{else}}
            <span>今日未发现外链</span>
          {{end}}
        </div>
        <div class="metric-card">
          <strong>群氛指数</strong>
          <div class="value">{{.Summary.GroupVibes.Score}}</div>
          <span>{{if .Summary.GroupVibes.Tone}}{{.Summary.GroupVibes.Tone}}{{else}}氛围待观察{{end}}</span>
        </div>
      </div>
      {{if .Summary.Highlights}}
      <h3>要点速览</h3>
      <ul>
        {{range .Summary.Highlights}}<li>{{.}}</li>{{end}}
      </ul>
      {{end}}
    </section>

    {{if gt .Summary.TotalMessages 0}}
    <section class="panel">
      <h2>群氛温度计</h2>
      <div class="metric-grid">
        <div class="metric-card">
          <strong>活跃度</strong>
          <div class="value">{{percent .Summary.GroupVibes.Activity}}</div>
          <span>综合消息量与参与度</span>
        </div>
        <div class="metric-card">
          <strong>情绪指数</strong>
          <div class="value">{{percent .Summary.GroupVibes.Sentiment}}</div>
          <span>正向表达占比</span>
        </div>
        <div class="metric-card">
          <strong>信息密度</strong>
          <div class="value">{{percent .Summary.GroupVibes.InfoDensity}}</div>
          <span>链接/长文/资料占比</span>
        </div>
        <div class="metric-card">
          <strong>争议度</strong>
          <div class="value">{{percent .Summary.GroupVibes.Controversy}}</div>
          <span>问答、@ 提及、感叹</span>
        </div>
      </div>
      {{if .Summary.GroupVibes.Reasons}}
      <h3>氛围解读</h3>
      <ul>
        {{range .Summary.GroupVibes.Reasons}}<li>{{.}}</li>{{end}}
      </ul>
      {{end}}
    </section>
    {{end}}

    {{if .AIInsights}}
    <section class="panel panel-highlight">
      <h2>AI 洞察</h2>
      {{if .AIInsights.Overview}}<p class="lead">{{.AIInsights.Overview}}</p>{{end}}
      <div class="insight-grid">
        {{if .AIInsights.Highlights}}
        <div>
          <h3>值得关注</h3>
          <ul>{{range .AIInsights.Highlights}}<li>{{.}}</li>{{end}}</ul>
        </div>
        {{end}}
        {{if .AIInsights.Opportunities}}
        <div>
          <h3>潜在机会</h3>
          <ul>{{range .AIInsights.Opportunities}}<li>{{.}}</li>{{end}}</ul>
        </div>
        {{end}}
        {{if .AIInsights.Risks}}
        <div>
          <h3>风险与预警</h3>
          <ul>{{range .AIInsights.Risks}}<li>{{.}}</li>{{end}}</ul>
        </div>
        {{end}}
        {{if .AIInsights.Actions}}
        <div>
          <h3>建议行动</h3>
          <ul>{{range .AIInsights.Actions}}<li>{{.}}</li>{{end}}</ul>
        </div>
        {{end}}
      </div>
      {{if .AIInsights.Spotlight}}
      <p style="margin-top:18px;font-size:14px;color:var(--muted);">今日金句：{{.AIInsights.Spotlight}}</p>
      {{end}}
    </section>
    {{end}}

    <section class="panel">
      <h2>互动热度</h2>
      <div class="activity-bars">
        {{range .ActivitySeries}}
          <div class="activity-bar" style="--value: {{.Percent}}"></div>
        {{end}}
      </div>
      <div class="activity-labels">
        {{range .ActivitySeries}}
          <span>{{.Label}}</span>
        {{end}}
      </div>
    </section>

    {{ $debt := .Summary.ReplyDebt }}
    {{if or (gt (len $debt.Outstanding) 0) (gt (len $debt.Resolved) 0)}}
    <section class="panel">
      <h2>回复债</h2>
      <div class="metric-grid">
        <div class="metric-card">
          <strong>待跟进问题</strong>
          <div class="value">{{len $debt.Outstanding}}</div>
          <span>尚未收到回应</span>
        </div>
        <div class="metric-card">
          <strong>平均响应</strong>
          <div class="value">{{printf "%.1f" $debt.AvgResponseMinutes}}</div>
          <span>分钟/问题</span>
        </div>
        <div class="metric-card">
          <strong>最佳催办时段</strong>
          {{if $debt.BestResponseHours}}
            <div class="value">{{printf "%02d:00" (index $debt.BestResponseHours 0)}}</div>
            <div class="chip-list" style="margin-top:8px;">
              {{range $debt.BestResponseHours}}<span>{{printf "%02d:00" .}}</span>{{end}}
            </div>
          {{else}}
            <div class="value">--</div>
            <span>暂无数据</span>
          {{end}}
        </div>
      </div>
      <div class="list-grid">
        <div>
          <h3>待回复</h3>
          <ul class="rank-list">
            {{range $debt.Outstanding}}
              <li class="rank-item">
                <strong>{{.Questioner}}</strong> · {{.Question}}
                {{if .Mentions}}
                  <div style="margin-top:4px;font-size:12px;color:var(--muted);">点名：{{join .Mentions "、"}}</div>
                {{end}}
                {{if .AgeMinutes}}
                  <div style="margin-top:4px;font-size:12px;color:var(--muted);">已等待 {{printf "%.0f" .AgeMinutes}} 分钟</div>
                {{end}}
              </li>
            {{else}}
              <li class="rank-item">暂无待回复问题</li>
            {{end}}
          </ul>
        </div>
        <div>
          <h3>已解决</h3>
          <ul class="rank-list">
            {{range $debt.Resolved}}
              <li class="rank-item">
                <strong>{{.Questioner}}</strong> · {{.Question}}
                {{if .Responders}}
                  <div style="margin-top:4px;font-size:12px;color:var(--muted);">回复：{{join .Responders "、"}}</div>
                {{end}}
                {{if .ResponseMinutes}}
                  <div style="margin-top:4px;font-size:12px;color:var(--muted);">用时 {{printf "%.1f" .ResponseMinutes}} 分钟</div>
                {{end}}
              </li>
            {{else}}
              <li class="rank-item">暂无已回复记录</li>
            {{end}}
          </ul>
        </div>
      </div>
    </section>
    {{end}}

    <section class="panel">
      <h2>群内热议</h2>
      <div class="list-grid">
        <div>
          <h3>Top 发送者</h3>
          <ul class="rank-list">
            {{range .SenderViews}}
              <li class="rank-item">
                <strong>{{.Name}}</strong> · {{.Count}} 条
                <div class="rank-meter"><span style="width: {{printf "%.0f%%" .Percent}};"></span></div>
              </li>
            {{else}}
              <li class="rank-item">暂无发送者数据</li>
            {{end}}
          </ul>
        </div>
        <div>
          <h3>热门链接</h3>
          <ul class="rank-list">
            {{range .LinkViews}}
              <li class="rank-item">
                <a href="{{.URL}}" target="_blank" rel="noreferrer noopener" style="font-weight:600;display:inline-block;">
                  {{if .Title}}{{.Title}}{{else}}{{.Host}}{{end}}
                </a>
                {{if .Host}}
                  <div style="margin-top:4px;font-size:12px;color:var(--muted);">来源：{{.Host}}</div>
                {{end}}
                {{if .Desc}}
                  <div style="margin-top:6px;font-size:13px;color:var(--muted);">{{.Desc}}</div>
                {{else if .Snippet}}
                  <div style="margin-top:6px;font-size:13px;color:var(--muted);">{{.Snippet}}</div>
                {{end}}
                <div style="margin-top:6px;font-size:12px;word-break:break-all;">
                  <a href="{{.URL}}" target="_blank" rel="noreferrer noopener">{{.URL}}</a>
                </div>
              </li>
            {{else}}
              <li class="rank-item">暂无外链</li>
            {{end}}
          </ul>
        </div>
        <div>
          <h3>主题概览</h3>
          <ul class="rank-list">
            {{range .Summary.Topics}}
              <li class="rank-item">
                <strong>{{.Name}}</strong> · {{.Count}} 次
                {{if .Representative}}<div style="margin-top:6px;font-size:13px;color:var(--muted);">代表内容：{{.Representative}}</div>{{end}}
              </li>
            {{else}}
              <li class="rank-item">暂无主题</li>
            {{end}}
          </ul>
        </div>
      </div>
      {{if .KeywordViews}}
      <h3>关键词热度</h3>
      <div class="chip-list">
        {{range .KeywordViews}}<span>{{.Text}} · {{.Count}}</span>{{end}}
      </div>
      {{end}}
    </section>

    <section class="panel">
      <h2>消息时间线</h2>
      <details class="report-messages">
        <summary>展开查看 {{.Summary.TotalMessages}} 条历史消息{{if gt .HiddenMessageCount 0}}（仅展示最近 {{len .Messages}} 条）{{end}}</summary>
        <div class="message-stream">
          {{range .Messages}}
            <div class="msg-card">
              <div class="msg-meta">
                <span>{{if .Time}}{{.Time}}{{else}}{{if .Timestamp}}{{formatTimestamp .Timestamp}}{{else}}{{.CreateTime}}{{end}}{{end}}</span>
                <span>{{if .SenderName}}{{.SenderName}}{{else}}{{if .Nickname}}{{.Nickname}}{{else}}{{if .Sender}}{{.Sender}}{{else}}{{.From}}{{end}}{{end}}{{end}}</span>
              </div>
              <div class="msg-body">
                {{if isImage .}}
                  {{ $src := imageURL $.ImageBaseURL . }}
                  {{if $src}}
                    <a href="{{$src}}" target="_blank" rel="noreferrer noopener"><img src="{{$src}}" data-media-src="{{$src}}" alt="图片"/></a>
                  {{else}}
                    <em>图片（未配置图片服务，无法预览）</em>
                  {{end}}
                {{else}}
              {{if .Content}}{{.Content}}{{else}}{{.Text}}{{end}}
              {{if .Share}}
                <div style="margin-top:8px;padding:12px;border:1px solid var(--border);border-radius:12px;background:rgba(53,99,255,0.05);">
                  <strong>{{.Share.Title}}</strong>
                  {{if .Share.Desc}}<div style="margin-top:4px;font-size:13px;color:var(--muted);">{{.Share.Desc}}</div>{{end}}
                  {{if .Share.URL}}<div style="margin-top:8px;font-size:13px;"><a href="{{.Share.URL}}" target="_blank" rel="noreferrer noopener">{{.Share.URL}}</a></div>{{end}}
                </div>
              {{end}}
            {{end}}
          </div>
        </div>
        {{end}}
      </div>
      </details>
    </section>
  </main>

  <footer>由 wechat-view 自动生成 · {{.Date}}</footer>
  <script>
    document.addEventListener('error', function (event) {
      var target = event.target;
      if (target && target.dataset && target.dataset.mediaSrc && target.tagName === 'IMG') {
        var wrapper = document.createElement('div');
        wrapper.style.marginTop = '8px';
        var video = document.createElement('video');
        video.src = target.dataset.mediaSrc;
        video.controls = true;
        video.playsInline = true;
        video.style.maxWidth = '100%';
        video.style.borderRadius = '12px';
        wrapper.appendChild(video);
        target.replaceWith(wrapper);
      }
    }, true);
  </script>
</body>
</html>
{{end}}
